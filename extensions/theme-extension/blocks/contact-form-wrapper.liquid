{{ 'contact-form.css' | asset_url | stylesheet_tag: preload: 'true' }}
{% schema %}
{
  "name": "Contact Form",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "form_title",
      "label": "Form Title",
      "default": "Get in Touch"
    },
    {
      "type": "text",
      "id": "first_name_label",
      "label": "First Name Label",
      "default": "First Name"
    },
    {
      "type": "text",
      "id": "last_name_label",
      "label": "Last Name Label",
      "default": "Last Name"
    },
    {
      "type": "text",
      "id": "email_label",
      "label": "Email Label",
      "default": "Email"
    },
    {
      "type": "text",
      "id": "phone_label",
      "label": "Phone Label",
      "default": "Phone"
    },
    {
      "type": "text",
      "id": "message_label",
      "label": "Message Label",
      "default": "Message"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Submit"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color (Button)",
      "default": "#007bff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "label_color",
      "label": "Label Color",
      "default": "#555555"
    },
    {
      "type": "color",
      "id": "input_border_color",
      "label": "Input Border Color",
      "default": "#dddddd"
    },
    {
      "type": "color",
      "id": "button_hover_color",
      "label": "Button Hover Color",
      "default": "#0056b3"
    },
    {
      "type": "color",
      "id": "success_color",
      "label": "Success Message Color",
      "default": "#28a745"
    },
    {
      "type": "color",
      "id": "error_color",
      "label": "Error Message Color",
      "default": "#dc3545"
    }
  ]
}
{% endschema %}

<div class="contact-form-wrapper" {{ block.shopify_attributes }}>
  <style>
    :root {
      --primary-color: {{ block.settings.primary_color }};
      --text-color: {{ block.settings.text_color }};
      --label-color: {{ block.settings.label_color }};
      --input-border-color: {{ block.settings.input_border_color }};
      --button-hover-color: {{ block.settings.button_hover_color }};
      --success-color: {{ block.settings.success_color }};
      --error-color: {{ block.settings.error_color }};
    }
  </style>

  <div class="contact-form-container">
    <h2 class="form-title">{{ block.settings.form_title }}</h2>

    <form class="contact-form" id="customContactForm">
      <div class="form-group">
        <label for="first-name" class="form-label">{{ block.settings.first_name_label }}</label>
        <input
          type="text"
          id="first-name"
          name="firstName"
          class="form-input"
          placeholder="Enter your first name"
          required
        >
        <span class="error-text"></span>
      </div>

      <div class="form-group">
        <label for="last-name" class="form-label">{{ block.settings.last_name_label }}</label>
        <input
          type="text"
          id="last-name"
          name="lastName"
          class="form-input"
          placeholder="Enter your last name"
        >
      </div>

      <div class="form-group">
        <label for="email" class="form-label">{{ block.settings.email_label }}</label>
        <input
          type="email"
          id="email"
          name="email"
          class="form-input"
          placeholder="Enter your email"
          required
        >
        <span class="error-text"></span>
      </div>

      <div class="form-group">
        <label for="phone" class="form-label">{{ block.settings.phone_label }}</label>
        <input
          type="tel"
          id="phone"
          name="phone"
          class="form-input"
          placeholder="Enter your phone number"
        >
        <span class="error-text"></span>
      </div>

      <div class="form-group">
        <label for="message" class="form-label">{{ block.settings.message_label }}</label>
        <textarea
          id="message"
          name="message"
          class="form-textarea"
          placeholder="Enter your message"
          rows="5"
        ></textarea>
      </div>

      <button type="submit" class="form-button" id="submitBtn">
        {{ block.settings.button_text }}
      </button>
    </form>

    <div id="result" class="result-message"></div>

    <!-- Hidden form for Shopify native contact submission -->
    <form id="shopifyContactForm" method="POST" action="/contact" style="display: none;">
      <input type="hidden" name="form_type" value="contact">
      <input type="hidden" name="utf8" value="âœ“">
      <input type="hidden" id="shopifyName" name="contact[Name]">
      <input type="hidden" id="shopifyEmail" name="contact[email]">
      <input type="hidden" id="shopifyPhone" name="contact[Phone number]">
      <input type="hidden" id="shopifyComment" name="contact[Comment]">
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('customContactForm');
    const shopifyForm = document.getElementById('shopifyContactForm');
    const resultDiv = document.getElementById('result');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Clear previous errors
      document.querySelectorAll('.error-text').forEach(el => el.textContent = '');
      resultDiv.textContent = '';
      resultDiv.className = 'result-message';

      const firstName = document.getElementById('first-name').value.trim();
      const lastName = document.getElementById('last-name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const message = document.getElementById('message').value.trim();

      // Client-side validation
      let isValid = true;
      if (!firstName) {
        document.querySelector('[name="firstName"]').nextElementSibling.textContent = 'First name is required';
        isValid = false;
      }
      if (!email) {
        document.querySelector('[name="email"]').nextElementSibling.textContent = 'Email is required';
        isValid = false;
      }
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        document.querySelector('[name="email"]').nextElementSibling.textContent = 'Invalid email format';
        isValid = false;
      }
      if (phone && !/^[+\d\-\s\(\)]{6,20}$/.test(phone)) {
        document.querySelector('[name="phone"]').nextElementSibling.textContent = 'Invalid phone number format';
        isValid = false;
      }

      if (!isValid) return;

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      const payload = {
        shop: '{{ shop.domain }}',
        name: firstName,
        last_name: lastName,
        phoneNumber: phone,
        email: email,
        body: message,
      };

      try {
        // Step 1: Save to app database
        const response = await fetch('https://86a866df8824.ngrok-free.app/api/contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await response.json();

        if (!response.ok) {
          resultDiv.classList.add('error');
          resultDiv.textContent = 'Error: ' + (data.error || 'Unknown error');
          submitBtn.disabled = false;
          submitBtn.textContent = '{{ block.settings.button_text }}';
          return;
        }

        // Step 2: Submit to Shopify native contact form
        document.getElementById('shopifyName').value = firstName + (lastName ? ' ' + lastName : '');
        document.getElementById('shopifyEmail').value = email;
        document.getElementById('shopifyPhone').value = phone;
        document.getElementById('shopifyComment').value = message;

        // Submit Shopify form
        shopifyForm.submit();

        // Show success message
        resultDiv.classList.add('success');
        resultDiv.textContent = 'Form submitted successfully!';
        form.reset();

        setTimeout(() => {
          resultDiv.classList.remove('success');
          resultDiv.textContent = '';
        }, 5000);
      } catch (error) {
        console.error('Submission error:', error);
        resultDiv.classList.add('error');
        resultDiv.textContent = 'Failed to submit form. Please try again.';
        submitBtn.disabled = false;
        submitBtn.textContent = '{{ block.settings.button_text }}';
      }
    });
  });
</script>